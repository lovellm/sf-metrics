CREATE OR REPLACE PROCEDURE SF_METRICS.P_QUERY_HISTORY (DAYS_START INTEGER DEFAULT 2, DAYS_END INTEGER DEFAULT 0)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
BEGIN
  INSERT INTO SF_METRICS.QUERY_HISTORY (
    LOGDATE
    , QUERY_ID
    , QUERY_TEXT
    , DATABASE_ID
    , DATABASE_NAME
    , SCHEMA_ID
    , SCHEMA_NAME
    , QUERY_TYPE
    , SESSION_ID
    , USER_NAME
    , ROLE_NAME
    , WAREHOUSE_ID
    , WAREHOUSE_NAME
    , WAREHOUSE_SIZE
    , WAREHOUSE_TYPE
    , CLUSTER_NUMBER
    , QUERY_TAG
    , EXECUTION_STATUS
    , ERROR_CODE
    , ERROR_MESSAGE
    , START_TIME
    , END_TIME
    , TOTAL_ELAPSED_TIME
    , BYTES_SCANNED
    , PERCENTAGE_SCANNED_FROM_CACHE
    , BYTES_WRITTEN
    , BYTES_WRITTEN_TO_RESULT
    , BYTES_READ_FROM_RESULT
    , ROWS_PRODUCED
    , ROWS_INSERTED
    , ROWS_UPDATED
    , ROWS_DELETED
    , ROWS_UNLOADED
    , BYTES_DELETED
    , PARTITIONS_SCANNED
    , PARTITIONS_TOTAL
    , BYTES_SPILLED_TO_LOCAL_STORAGE
    , BYTES_SPILLED_TO_REMOTE_STORAGE
    , BYTES_SENT_OVER_THE_NETWORK
    , COMPILATION_TIME
    , EXECUTION_TIME
    , QUEUED_PROVISIONING_TIME
    , QUEUED_REPAIR_TIME
    , QUEUED_OVERLOAD_TIME
    , TRANSACTION_BLOCKED_TIME
    , OUTBOUND_DATA_TRANSFER_CLOUD
    , OUTBOUND_DATA_TRANSFER_REGION
    , OUTBOUND_DATA_TRANSFER_BYTES
    , INBOUND_DATA_TRANSFER_CLOUD
    , INBOUND_DATA_TRANSFER_REGION
    , INBOUND_DATA_TRANSFER_BYTES
    , LIST_EXTERNAL_FILES_TIME
    , CREDITS_USED_CLOUD_SERVICES
    , RELEASE_VERSION
    , EXTERNAL_FUNCTION_TOTAL_INVOCATIONS
    , EXTERNAL_FUNCTION_TOTAL_SENT_ROWS
    , EXTERNAL_FUNCTION_TOTAL_RECEIVED_ROWS
    , EXTERNAL_FUNCTION_TOTAL_SENT_BYTES
    , EXTERNAL_FUNCTION_TOTAL_RECEIVED_BYTES
    , QUERY_LOAD_PERCENT
    , IS_CLIENT_GENERATED_STATEMENT
    , QUERY_ACCELERATION_BYTES_SCANNED
    , QUERY_ACCELERATION_PARTITIONS_SCANNED
    , QUERY_ACCELERATION_UPPER_LIMIT_SCALE_FACTOR
    , TRANSACTION_ID
    , CHILD_QUERIES_WAIT_TIME
    , ROLE_TYPE
    , QUERY_HASH
    , QUERY_HASH_VERSION
    , QUERY_PARAMETERIZED_HASH
    , QUERY_PARAMETERIZED_HASH_VERSION
    , ROWS_WRITTEN_TO_RESULT
    , QUERY_RETRY_TIME
    , QUERY_RETRY_CAUSE
    , FAULT_HANDLING_TIME
    , USER_TYPE
    , USER_DATABASE_NAME
    , USER_DATABASE_ID
    , USER_SCHEMA_NAME
    , USER_SCHEMA_ID
  )
  SELECT
    START_TIME::DATE AS LOGDATE
    , QUERY_ID
    , QUERY_TEXT
    , DATABASE_ID
    , DATABASE_NAME
    , SCHEMA_ID
    , SCHEMA_NAME
    , QUERY_TYPE
    , SESSION_ID
    , USER_NAME
    , ROLE_NAME
    , WAREHOUSE_ID
    , WAREHOUSE_NAME
    , WAREHOUSE_SIZE
    , WAREHOUSE_TYPE
    , CLUSTER_NUMBER
    , QUERY_TAG
    , EXECUTION_STATUS
    , ERROR_CODE
    , ERROR_MESSAGE
    , START_TIME
    , END_TIME
    , TOTAL_ELAPSED_TIME
    , BYTES_SCANNED
    , PERCENTAGE_SCANNED_FROM_CACHE
    , BYTES_WRITTEN
    , BYTES_WRITTEN_TO_RESULT
    , BYTES_READ_FROM_RESULT
    , ROWS_PRODUCED
    , ROWS_INSERTED
    , ROWS_UPDATED
    , ROWS_DELETED
    , ROWS_UNLOADED
    , BYTES_DELETED
    , PARTITIONS_SCANNED
    , PARTITIONS_TOTAL
    , BYTES_SPILLED_TO_LOCAL_STORAGE
    , BYTES_SPILLED_TO_REMOTE_STORAGE
    , BYTES_SENT_OVER_THE_NETWORK
    , COMPILATION_TIME
    , EXECUTION_TIME
    , QUEUED_PROVISIONING_TIME
    , QUEUED_REPAIR_TIME
    , QUEUED_OVERLOAD_TIME
    , TRANSACTION_BLOCKED_TIME
    , OUTBOUND_DATA_TRANSFER_CLOUD
    , OUTBOUND_DATA_TRANSFER_REGION
    , OUTBOUND_DATA_TRANSFER_BYTES
    , INBOUND_DATA_TRANSFER_CLOUD
    , INBOUND_DATA_TRANSFER_REGION
    , INBOUND_DATA_TRANSFER_BYTES
    , LIST_EXTERNAL_FILES_TIME
    , CREDITS_USED_CLOUD_SERVICES
    , RELEASE_VERSION
    , EXTERNAL_FUNCTION_TOTAL_INVOCATIONS
    , EXTERNAL_FUNCTION_TOTAL_SENT_ROWS
    , EXTERNAL_FUNCTION_TOTAL_RECEIVED_ROWS
    , EXTERNAL_FUNCTION_TOTAL_SENT_BYTES
    , EXTERNAL_FUNCTION_TOTAL_RECEIVED_BYTES
    , QUERY_LOAD_PERCENT
    , IS_CLIENT_GENERATED_STATEMENT
    , QUERY_ACCELERATION_BYTES_SCANNED
    , QUERY_ACCELERATION_PARTITIONS_SCANNED
    , QUERY_ACCELERATION_UPPER_LIMIT_SCALE_FACTOR
    , TRANSACTION_ID
    , CHILD_QUERIES_WAIT_TIME
    , ROLE_TYPE
    , QUERY_HASH
    , QUERY_HASH_VERSION
    , QUERY_PARAMETERIZED_HASH
    , QUERY_PARAMETERIZED_HASH_VERSION
    , ROWS_WRITTEN_TO_RESULT
    , QUERY_RETRY_TIME
    , QUERY_RETRY_CAUSE
    , FAULT_HANDLING_TIME
    , USER_TYPE
    , USER_DATABASE_NAME
    , USER_DATABASE_ID
    , USER_SCHEMA_NAME
    , USER_SCHEMA_ID
  FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
  WHERE
    START_TIME < DATEADD('hours', -6, CURRENT_TIMESTAMP())
    AND START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
    AND START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    AND QUERY_ID NOT IN (
      SELECT QUERY_ID
      FROM SF_METRICS.QUERY_HISTORY
      WHERE START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
        AND START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    )
  ;

  RETURN TRUE;
EXCEPTION
  WHEN OTHER THEN
    RAISE;
END;
$$
;
