CREATE OR REPLACE PROCEDURE SF_METRICS.P_USERS ()
RETURNS VARIANT
LANGUAGE SQL
AS
$$
BEGIN
  INSERT OVERWRITE INTO SF_METRICS.USERS (
    USER_ID
    , NAME
    , CREATED_ON
    , DELETED_ON
    , LOGIN_NAME
    , DISPLAY_NAME
    , FIRST_NAME
    , LAST_NAME
    , EMAIL
    , HAS_PASSWORD
    , COMMENT
    , DEFAULT_WAREHOUSE
    , DEFAULT_ROLE
    , LAST_SUCCESS_LOGIN
    , OWNER
    , TYPE
    , DATABASE_NAME
    , DATABASE_ID
    , SCHEMA_NAME
    , SCHEMA_ID
  )
  SELECT
    MAX_BY(USER_ID, CREATED_ON) as USER_ID
    , NAME
    , MAX(CREATED_ON) AS CREATED_ON
    , MAX(DELETED_ON) AS DELETED_ON
    , MAX_BY(LOGIN_NAME, CREATED_ON) AS LOGIN_NAME
    , MAX_BY(DISPLAY_NAME, CREATED_ON) AS DISPLAY_NAME
    , MAX_BY(FIRST_NAME, CREATED_ON) AS FIRST_NAME
    , MAX_BY(LAST_NAME, CREATED_ON) AS LAST_NAME
    , MAX_BY(EMAIL, CREATED_ON) AS EMAIL
    , MAX_BY(HAS_PASSWORD, CREATED_ON) AS HAS_PASSWORD
    , MAX_BY(COMMENT, CREATED_ON) AS COMMENT
    , MAX_BY(DEFAULT_WAREHOUSE, CREATED_ON) AS DEFAULT_WAREHOUSE
    , MAX_BY(DEFAULT_ROLE, CREATED_ON) AS DEFAULT_ROLE
    , MAX_BY(LAST_SUCCESS_LOGIN, CREATED_ON) AS LAST_SUCCESS_LOGIN
    , MAX_BY(OWNER, CREATED_ON) AS OWNER
    , MAX_BY(TYPE, CREATED_ON) AS TYPE
    , MAX_BY(DATABASE_NAME, CREATED_ON) AS DATABASE_NAME
    , MAX_BY(DATABASE_ID, CREATED_ON) AS DATABASE_ID
    , MAX_BY(SCHEMA_NAME, CREATED_ON) AS SCHEMA_NAME
    , MAX_BY(SCHEMA_ID, CREATED_ON) AS SCHEMA_ID
  FROM
    SNOWFLAKE.ACCOUNT_USAGE.USERS
  GROUP BY NAME
  ;
  RETURN TRUE;
EXCEPTION
  WHEN OTHER THEN
    RAISE;
END;
$$
;
