CREATE OR REPLACE PROCEDURE SF_METRICS.P_DYNAMIC_TABLE_REFRESH_HISTORY (DAYS_START INTEGER DEFAULT 2, DAYS_END INTEGER DEFAULT 0)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
BEGIN
  INSERT INTO SF_METRICS.DYNAMIC_TABLE_REFRESH_HISTORY (
    LOGDATE
    , NAME
    , SCHEMA_NAME
    , DATABASE_NAME
    , ID
    , SCHEMA_ID
    , DATABASE_ID
    , STATE
    , STATE_CODE
    , STATE_MESSAGE
    , QUERY_ID
    , DATA_TIMESTAMP
    , REFRESH_START_TIME
    , REFRESH_END_TIME
    , COMPLETION_TARGET
    , QUALIFIED_NAME
    , LAST_COMPLETED_DEPENDENCY
    , STATISTICS
    , REFRESH_ACTION
    , REFRESH_TRIGGER
    , TARGET_LAG_SEC
    , GRAPH_HISTORY_VALID_FROM
  )
  SELECT
    REFRESH_START_TIME::DATE AS LOGDATE
    , NAME
    , SCHEMA_NAME
    , DATABASE_NAME
    , ID
    , SCHEMA_ID
    , DATABASE_ID
    , STATE
    , STATE_CODE
    , STATE_MESSAGE
    , QUERY_ID
    , DATA_TIMESTAMP
    , REFRESH_START_TIME
    , REFRESH_END_TIME
    , COMPLETION_TARGET
    , QUALIFIED_NAME
    , LAST_COMPLETED_DEPENDENCY
    , STATISTICS
    , REFRESH_ACTION
    , REFRESH_TRIGGER
    , TARGET_LAG_SEC
    , GRAPH_HISTORY_VALID_FROM
  FROM SNOWFLAKE.ACCOUNT_USAGE.DYNAMIC_TABLE_REFRESH_HISTORY
  WHERE
    REFRESH_START_TIME < DATEADD('hours', -6, CURRENT_TIMESTAMP())
    AND REFRESH_START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
    AND REFRESH_START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    AND QUERY_ID NOT IN (
      SELECT QUERY_ID
      FROM SF_METRICS.DYNAMIC_TABLE_REFRESH_HISTORY
      WHERE REFRESH_START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
        AND REFRESH_START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    )
  ;

  RETURN TRUE;
EXCEPTION
  WHEN OTHER THEN
    RAISE;
END;
$$
;
