CREATE OR REPLACE PROCEDURE SF_METRICS.P_WAREHOUSE_METERING_HISTORY (DAYS_START INTEGER DEFAULT 2, DAYS_END INTEGER DEFAULT 0)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
BEGIN
  MERGE INTO SF_METRICS.WAREHOUSE_METERING_HISTORY TGT
  USING (
    SELECT
      START_TIME::DATE AS LOGDATE
      , START_TIME
      , END_TIME
      , WAREHOUSE_ID
      , WAREHOUSE_NAME
      , CREDITS_USED
      , CREDITS_USED_COMPUTE
      , CREDITS_USED_CLOUD_SERVICES
      , CREDITS_ATTRIBUTED_COMPUTE_QUERIES
      FROM
        SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY
      WHERE
        -- at least 6 hours ago, to make sure the columns are populated and complete
        START_TIME < DATEADD('hours', -6, CURRENT_TIMESTAMP())
        AND START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
        AND START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
  ) as SRC
    ON (
      TGT.START_TIME = SRC.START_TIME
      AND TGT.END_TIME = SRC.END_TIME
      AND TGT.WAREHOUSE_ID = SRC.WAREHOUSE_ID
    )
  WHEN NOT MATCHED THEN 
    INSERT (
      LOGDATE
      , START_TIME
      , END_TIME
      , WAREHOUSE_ID
      , WAREHOUSE_NAME
      , CREDITS_USED
      , CREDITS_USED_COMPUTE
      , CREDITS_USED_CLOUD_SERVICES
      , CREDITS_ATTRIBUTED_COMPUTE_QUERIES
    ) 
    VALUES (
      SRC.LOGDATE
      , SRC.START_TIME
      , SRC.END_TIME
      , SRC.WAREHOUSE_ID
      , SRC.WAREHOUSE_NAME
      , SRC.CREDITS_USED
      , SRC.CREDITS_USED_COMPUTE
      , SRC.CREDITS_USED_CLOUD_SERVICES
      , SRC.CREDITS_ATTRIBUTED_COMPUTE_QUERIES
    )
  ;

  RETURN TRUE;
EXCEPTION
  WHEN OTHER THEN
    RAISE;
END;
$$
;
