CREATE OR REPLACE PROCEDURE SF_METRICS.P_SERVERLESS_TASK_HISTORY (DAYS_START INTEGER DEFAULT 2, DAYS_END INTEGER DEFAULT 0)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
BEGIN
  INSERT INTO SF_METRICS.SERVERLESS_TASK_HISTORY (
    LOGDATE
    , START_TIME
    , END_TIME
    , CREDITS_USED
    , TASK_ID
    , TASK_NAME
    , SCHEMA_ID
    , SCHEMA_NAME
    , DATABASE_ID
    , DATABASE_NAME
    , INSTANCE_ID
  )
  SELECT
    START_TIME::DATE AS LOGDATE
    , START_TIME
    , END_TIME
    , CREDITS_USED
    , TASK_ID
    , TASK_NAME
    , SCHEMA_ID
    , SCHEMA_NAME
    , DATABASE_ID
    , DATABASE_NAME
    , INSTANCE_ID
  FROM SNOWFLAKE.ACCOUNT_USAGE.SERVERLESS_TASK_HISTORY
  WHERE
    START_TIME < DATEADD('hours', -6, CURRENT_TIMESTAMP())
    AND START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
    AND START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    AND (TASK_ID, START_TIME) NOT IN (
      SELECT TASK_ID, START_TIME
      FROM SF_METRICS.SERVERLESS_TASK_HISTORY
      WHERE START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
        AND START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    )
  ;

  RETURN TRUE;
EXCEPTION
  WHEN OTHER THEN
    RAISE;
END;
$$
;
