CREATE OR REPLACE PROCEDURE SF_METRICS.P_TASK_HISTORY (DAYS_START INTEGER DEFAULT 2, DAYS_END INTEGER DEFAULT 0)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
BEGIN
  INSERT INTO SF_METRICS.TASK_HISTORY (
    LOGDATE
    , NAME
    , QUERY_TEXT
    , CONDITION_TEXT
    , SCHEMA_NAME
    , TASK_SCHEMA_ID
    , DATABASE_NAME
    , TASK_DATABASE_ID
    , SCHEDULED_TIME
    , COMPLETED_TIME
    , STATE
    , RETURN_VALUE
    , QUERY_ID
    , QUERY_START_TIME
    , ERROR_CODE
    , ERROR_MESSAGE
    , GRAPH_VERSION
    , RUN_ID
    , ROOT_TASK_ID
    , SCHEDULED_FROM
    , ATTEMPT_NUMBER
    , INSTANCE_ID
    , CONFIG
    , QUERY_HASH
    , QUERY_HASH_VERSION
    , QUERY_PARAMETERIZED_HASH
    , QUERY_PARAMETERIZED_HASH_VERSION
    , GRAPH_RUN_GROUP_ID
    , BACKFILL_INFO
  )
  SELECT
    SCHEDULED_TIME::DATE AS LOGDATE
    , NAME
    , QUERY_TEXT
    , CONDITION_TEXT
    , SCHEMA_NAME
    , TASK_SCHEMA_ID
    , DATABASE_NAME
    , TASK_DATABASE_ID
    , SCHEDULED_TIME
    , COMPLETED_TIME
    , STATE
    , RETURN_VALUE
    , QUERY_ID
    , QUERY_START_TIME
    , ERROR_CODE
    , ERROR_MESSAGE
    , GRAPH_VERSION
    , RUN_ID
    , ROOT_TASK_ID
    , SCHEDULED_FROM
    , ATTEMPT_NUMBER
    , INSTANCE_ID
    , CONFIG
    , QUERY_HASH
    , QUERY_HASH_VERSION
    , QUERY_PARAMETERIZED_HASH
    , QUERY_PARAMETERIZED_HASH_VERSION
    , GRAPH_RUN_GROUP_ID
    , BACKFILL_INFO
  FROM SNOWFLAKE.ACCOUNT_USAGE.TASK_HISTORY
  WHERE
    SCHEDULED_TIME < DATEADD('hours', -6, CURRENT_TIMESTAMP())
    AND SCHEDULED_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
    AND SCHEDULED_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    AND QUERY_ID NOT IN (
      SELECT QUERY_ID
      FROM SF_METRICS.TASK_HISTORY
      WHERE SCHEDULED_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
        AND SCHEDULED_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    )
  ;

  RETURN TRUE;
EXCEPTION
  WHEN OTHER THEN
    RAISE;
END;
$$
;
