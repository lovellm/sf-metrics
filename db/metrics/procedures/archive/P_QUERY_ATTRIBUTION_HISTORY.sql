CREATE OR REPLACE PROCEDURE SF_METRICS.P_QUERY_ATTRIBUTION_HISTORY (DAYS_START INTEGER DEFAULT 2, DAYS_END INTEGER DEFAULT 0)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
BEGIN
  INSERT INTO SF_METRICS.QUERY_ATTRIBUTION_HISTORY (
    LOGDATE
    , QUERY_ID
    , PARENT_QUERY_ID
    , ROOT_QUERY_ID
    , WAREHOUSE_ID
    , WAREHOUSE_NAME
    , QUERY_HASH
    , QUERY_PARAMETERIZED_HASH
    , QUERY_TAG
    , USER_NAME
    , START_TIME
    , END_TIME
    , CREDITS_ATTRIBUTED_COMPUTE
    , CREDITS_USED_QUERY_ACCELERATION
  )
  SELECT
    START_TIME::DATE AS LOGDATE
    , QUERY_ID
    , PARENT_QUERY_ID
    , ROOT_QUERY_ID
    , WAREHOUSE_ID
    , WAREHOUSE_NAME
    , QUERY_HASH
    , QUERY_PARAMETERIZED_HASH
    , QUERY_TAG
    , USER_NAME
    , START_TIME
    , END_TIME
    , CREDITS_ATTRIBUTED_COMPUTE
    , CREDITS_USED_QUERY_ACCELERATION
  FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_ATTRIBUTION_HISTORY
  WHERE
    START_TIME < DATEADD('hours', -6, CURRENT_TIMESTAMP())
    AND START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
    AND START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    AND QUERY_ID NOT IN (
      SELECT QUERY_ID
      FROM SF_METRICS.QUERY_ATTRIBUTION_HISTORY
      WHERE START_TIME >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
        AND START_TIME < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
    )
  ;

  RETURN TRUE;
EXCEPTION
  WHEN OTHER THEN
    RAISE;
END;
$$
;
