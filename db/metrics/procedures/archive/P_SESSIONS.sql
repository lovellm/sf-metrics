CREATE OR REPLACE PROCEDURE SF_METRICS.P_SESSIONS (DAYS_START INTEGER DEFAULT 2, DAYS_END INTEGER DEFAULT 0)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
BEGIN
  MERGE INTO SF_METRICS.SESSIONS TGT
  USING (
    SELECT
      CREATED_ON::DATE AS LOGDATE
      , SESSION_ID
      , CREATED_ON
      , USER_NAME
      , AUTHENTICATION_METHOD
      , LOGIN_EVENT_ID
      , CLIENT_APPLICATION_VERSION
      , CLIENT_APPLICATION_ID
      , CLIENT_ENVIRONMENT
      , CLIENT_BUILD_ID
      , CLIENT_VERSION
      , CLOSED_REASON
    FROM
      SNOWFLAKE.ACCOUNT_USAGE.SESSIONS
    WHERE
      CREATED_ON < DATEADD('hours', -6, CURRENT_TIMESTAMP())
      AND CREATED_ON >= DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_START, CURRENT_TIMESTAMP()))
       AND CREATED_ON < DATE_TRUNC('day', DATEADD('days', -1 * :DAYS_END, CURRENT_TIMESTAMP()))
  ) as SRC
    ON (
      TGT.SESSION_ID = SRC.SESSION_ID
    )
  WHEN NOT MATCHED THEN INSERT (
    LOGDATE
    , SESSION_ID
    , CREATED_ON
    , USER_NAME
    , AUTHENTICATION_METHOD
    , LOGIN_EVENT_ID
    , CLIENT_APPLICATION_VERSION
    , CLIENT_APPLICATION_ID
    , CLIENT_ENVIRONMENT
    , CLIENT_BUILD_ID
    , CLIENT_VERSION
    , CLOSED_REASON
  ) VALUES (
    SRC.LOGDATE
    , SRC.SESSION_ID
    , SRC.CREATED_ON
    , SRC.USER_NAME
    , SRC.AUTHENTICATION_METHOD
    , SRC.LOGIN_EVENT_ID
    , SRC.CLIENT_APPLICATION_VERSION
    , SRC.CLIENT_APPLICATION_ID
    , SRC.CLIENT_ENVIRONMENT
    , SRC.CLIENT_BUILD_ID
    , SRC.CLIENT_VERSION
    , SRC.CLOSED_REASON
  )
  WHEN MATCHED AND SRC.CLOSED_REASON <> TGT.CLOSED_REASON
  THEN UPDATE SET TGT.CLOSED_REASON = SRC.CLOSED_REASON

  ;
  RETURN TRUE;
EXCEPTION
  WHEN OTHER THEN
    RAISE;
END;
$$
;
